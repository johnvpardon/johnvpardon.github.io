#!/usr/bin/perl

system "cp ../cv/cv.pdf .";

system "cp ../writing/drafts/holomorphiccurves/copyright/holomorphiccurves-copyright-1.pdf holomorphiccurves-2021.pdf";
system "cp ../writing/drafts/holomorphiccurves/copyright/holomorphiccurves-copyright-2.pdf holomorphiccurves-2024.pdf";

open($BIB, "<", "../writing/pardon.bib") or die "ERROR: could not open ../writing/pardon.bib\n";
{
	local $/;
	$bib = <$BIB>;
}
close $BIB;

(@array) = ($bib =~ /(\@\w*\s*(\{([^{}]*|(?2))*\}))/g);
for (@array)
{
	if( m/^\@/)
	{
		@entries =(@entries, $_);
	}
}

open($PAPERSHTML, ">", "manuscripts.html") or die "ERROR: could not create file manuscripts.html\n";
#print $PAPERSHTML "<!--Do not edit this file directly; it is is automatically generated by the `makewebsite` program-->\n";
print $PAPERSHTML "<ol>\n";
$num = @entries;
for (@entries)
{
	my %entry;
	($entry{'type'}, $entry{'key'}) = /^\@(\w*)\s*\{\s*(\w*),/;
	@data = (/,\s*(\w*)\s*=\s*\{(.*)\}/g);
	for($i = 0 ; $i < @data ; $i += 2)
	{
		$entry{$data[$i]} = $data[$i + 1];
		#print "$data[$i],$data[$i + 1]\n";
	}
	
	print $PAPERSHTML "<p><li value=\"$num\">";
	if($entry{'AUTHOR'} ne "John Pardon")
	{
		if($entry{'AUTHORHTML'}){$all = $entry{'AUTHORHTML'}}else{$all = $entry{'AUTHOR'}}
		@alllist = split(/ and |, |John Pardon/, $all);
		print $PAPERSHTML "(with ".join(' and ', @alllist)."). ";
	}
	print $PAPERSHTML "<a href=\"";
	if($entry{'SPECIALURL'})
	{
		print $PAPERSHTML $entry{'SPECIALURL'};
	}
	else
	{
		system "cp ../writing/$entry{'papernum'}_$entry{'key'}/$entry{'key'}.pdf manuscripts/$entry{'papernum'}_$entry{'key'}.pdf";
		print $PAPERSHTML "manuscripts/$entry{'papernum'}_$entry{'key'}.pdf";
	}
	($htmltitle = $entry{'TITLE'}) =~ s/[{}]//g;
	print $PAPERSHTML "\">$htmltitle</a>. ";
	if($entry{'JOURNALHTML'}){$journal = $entry{'JOURNALHTML'}}elsif($entry{'JOURNAL'}){$journal = $entry{'JOURNAL'}}elsif($entry{'SERIES'}){$journal = $entry{'SERIES'}}
	print $PAPERSHTML "<EM>$journal</EM> ";
	if($entry{'VOLUME'}){print $PAPERSHTML "<STRONG>$entry{'VOLUME'}</STRONG> ";}
	print $PAPERSHTML "($entry{'YEAR'})";
	if($entry{'NUMBER'}){print $PAPERSHTML ", no. $entry{'NUMBER'}";}
	if($entry{'PAGES'}){print $PAPERSHTML ", $entry{'PAGES'}";}
	print $PAPERSHTML ".";
	if($entry{'URL'}){print $PAPERSHTML " <a href=\"$entry{'URL'}\">Published Version</a>."}
	if($entry{'MRNUMBER'}){($number) = ($entry{'MRNUMBER'} =~ /(\d*)(\D|$)/);print $PAPERSHTML " <a href=\"http://www.ams.org/mathscinet-getitem?mr=$number\">MR$number</a>."}
	print $PAPERSHTML "</li value></p>\n";
	
	if($entry{'AUTHOR'} ne "John Pardon")
	{
		$all = $entry{'AUTHOR'};
		@alllist = split(/ and |, |John Pardon/, $all);
	}
	$latexjournal = $entry{'JOURNAL'};
	$latexjournal =~ s/\. /\.\\ /g;
	
	$num--;
}
print $PAPERSHTML "</ol>\n";
close $PAPERSHTML;

open($INDEXTEMPLATE, "<", "index_template.html") or die "ERROR: could not find index_template.html\n";
open($INDEX, ">", "index.html") or die "ERROR: could not create index.html\n";
print $INDEX "<!--Do not edit this file directly; it is is automatically generated by the `makewebsite` program-->\n";
for(<$INDEXTEMPLATE>)
{
	($FILENAME) = ($_ =~ /\[(.*)\]/);
	if($FILENAME)
	{
		open($FILE, "<", $FILENAME) or die "ERROR: could not find manuscripts.html\n";
		for(<$FILE>){print $INDEX $_;}
		close $FILE;
	}
	else
	{
		print $INDEX $_;
	}
}
close($INDEX);
close($INDEXTEMPLATE);
system "rm -f manuscripts.html";
